# Peak Detection Configuration
# Dynamické parametry pro tuning peak detection algoritmu
# Lze upravovat bez restartování, hodnoty se načítají za běhu

peak_detection:
  # DETECTION LOGIC
  # is_peak = (ratio >= 3.0) OR (value >= aggregation_data.mean * 4.0)
  
  # PODMÍNKA 1: RATIO THRESHOLD (volatilita během dne)
  # ratio = original_value / reference
  # reference = průměr posledních 3 non-peak hodnot (stejný den, -15, -30, -45 min)
  ratio_multiplier: 3.0          # is_peak pokud: ratio >= 3.0
  
  # PODMÍNKA 2: ABSOLUTE THRESHOLD (7-denní baseline)
  # value = original_value
  # aggregation_data.mean = 7-denní průměr pro (den_týdne, hodina, čtvrt, namespace)
  absolute_threshold_multiplier: 4.0    # is_peak pokud: value >= aggregation_mean * 4.0
  
  # REFERENCE CALCULATION
  # Jak se počítá reference pro peak detection
  same_day_window_count: 3       # Počet okna zpět ve stejný den (-15, -30, -45 min)
  
  # REPLACEMENT VALUE
  # Pokud je detekován peak, replacement = aggregation_data.mean (NOT reference!)
  # aggregation_data.mean je stabilní 7-denní baseline
  
  # LOGGING
  log_path: "/tmp/peaks_replaced_v2.log"
  verbose: false                 # Verbose mode pro debugging



# ERROR LOGGING & CHAIN MONITORING
error_logging:
  # Sběr chyb z celého řetězce: ES -> sběr -> analýza -> výstupy
  enabled: true
  
  # Logování každého kroku
  elasticsearch_errors:
    log_connection_failures: true    # Chyby při připojování k ES
    log_query_failures: true         # Chyby při dotazování
    log_timeout_errors: true         # Query timeouty
    max_buffer_size: 10000           # Kolik chyb držet v bufferu
  
  data_collection_errors:
    log_parse_failures: true         # Chyby při parsování logů
    log_validation_failures: true    # Chyby validace dat
    log_duplicate_detection: true    # Detekce duplicitních záznamů
    max_retry_attempts: 3            # Kolik pokusů o retry
  
  peak_analysis_errors:
    log_threshold_calculation: true  # Chyby při výpočtu thresholdů
    log_baseline_missing: true       # Varování když chybí baseline
    log_invalid_data: true           # Detekce nevalidních dat
  
  output_errors:
    log_db_write_failures: true      # Chyby při zápisu do DB
    log_teams_notification_failures: true # Chyby Teams notificí
    log_file_write_failures: true    # Chyby zápisu do log souborů
  
  # Log location
  error_log_path: "/tmp/ailoganalyzer_errors.log"
  max_log_size_mb: 100               # Rotace logu když překročí 100MB
  keep_logs_days: 30                 # Smazat stará logy po 30 dnech

# AGGREGATION CONFIGURATION
aggregation:
  # Rolling update agregace
  rolling_window_days: 7         # Kolik dní pro baseline (obvykle 7 = 1 týden)
  recalc_interval_minutes: 15    # Jak často přepočítávat agregaci
  
  # Sample weighting (jak se počítají staré vs nové data)
  old_sample_weight: 0.8         # Váha starých vzorků (exponential decay)
  new_sample_weight: 1.0         # Váha nových vzorků

# ERROR PATTERN TRACKING
error_tracking:
  # Všechny errory se trackují do error_patterns tabulky
  enabled: true
  pattern_hash_algorithm: "md5"  # sha256, md5
  min_occurrence_for_analysis: 2 # Kolik výskytů aby se analyzoval AI
  
  # Severity classification
  severity_thresholds:
    low: 0.0       # Počet errors pro "low" severitu
    medium: 50.0   # Počet errors pro "medium" severitu
    high: 200.0    # Počet errors pro "high" severitu
    critical: 500.0 # Počet errors pro "critical" severitu

# KNOWN ISSUES & PEAKS
known_patterns:
  # Automatické matchování mezi peaky a známými issues
  enabled: true
  
  # Pattern matching tolerance (jak blízko musí být match)
  error_type_exact_match: true    # Pokud false, folosit fuzzy matching
  namespace_exact_match: true     # Pokud false, můžou se matchovat náhodné NS
  
  # Ratio tolerance pro matching (pokud peak ratio se liší od expected, pořád to matchovat?)
  ratio_tolerance: 0.2            # 20% tolerance (expected_ratio ± 20%)

# AI ANALYSIS
ai_analysis:
  # Které peaky se mají analyzovat AI
  min_confidence_for_ticket: 0.7  # Pokud AI confidence >= 0.7, otevřít ticket
  min_confidence_for_autofix: 0.85 # Pokud >= 0.85, zkusit auto-fix
  
  # LLM settings
  model: "claude-3-5-sonnet"      # Který model (openai, claude, ollama)
  temperature: 0.3                # Creative tolerance (0.0 = deterministic)
  max_tokens: 1000                # Max output length

# K8s DEPLOYMENT
kubernetes:
  # CronJob schedule
  cron_schedule: "*/15 * * * *"   # Každých 15 minut
  
  # Parallelism
  parallel_jobs: 3                # Kolik paralelních ingestion jobů
  
  # Retention
  peak_raw_data_retention_days: 30 # Auto-delete raw data starší 30 dní
  peak_investigation_retention_days: 365 # Audit log navždy (ale archiv po roce)
